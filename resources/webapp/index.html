<html>
  <head>
    <meta charset="utf-8">
    <meta name="description" content="">
    <meta name="keywords" content="">
    <title>Report server</title>
    <script src="jquery-1.12.2.min.js"></script>
    <script language="javascript" type="text/javascript">
      //Проверяем поддержку ajax у браузера
      var request = false;
      try {
          request = new XMLHttpRequest();
      } catch (trymicrosoft) {
        try {
            request = new ActiveXObject("Msxml2.XMLHTTP");
        } catch (othermicrosoft) {
          try {
              request = new ActiveXObject("Microsoft.XMLHTTP");
          } catch (failed) {
              request = false;
          }
        }
      }

      if (!request)
        alert("Error initializing XMLHttpRequest!");

      /**
      * Устанавливаем асинхронные запросы для отображения состояния сервера и
      * обработки сообщений для пользователя
      */
      $(document).ready(function() {
        getBluetoothServerStatus();
        getBluetoothMac();
        userMessageHandler();
        getOldUserMessages();
        getDetourFomDb();
        refreshDetourTable();
      });

      function refreshDetourTable() {
        $.ajax({
          url: '/tablerefresh',
          type: 'get',
          success: function() {
            $('.finish-row').remove();
            getDetourFomDb();
            refreshDetourTable();
          }
        });
      }

      function bluetoothServerStart() {
        $.ajax({
          url: '/btstart',
          type: 'get',
          dataType: "json",
          success: function(btStatus) {
            updateBluetoothServerStatus(btStatus.status);
          }
        });
      }

      function bluetoothServerStop() {
        $.ajax({
          url: '/btstop',
          type: 'get',
          dataType: "json",
          success: function(btStatus) {
            updateBluetoothServerStatus(btStatus.status);
          }
        });
      }

      function getBluetoothServerStatus() {
        $.ajax({
          url: '/btstatus',
          type: 'get',
          dataType: "json",
          success: function(btStatus) {
            updateBluetoothServerStatus(btStatus.status);
          }
        });
      }

      function updateBluetoothServerStatus(status) {
        $('#btServerStatus').html(status);
      }

      //Для обработки пользовательских сообщений
      var userMessageNumber = 0;

      function addUserMessageRow(date, text) {
        $('#userMessageTable').prepend("<tr><td><div class=\"debug-message\">"+date+"</div></td>"+
                                       "<td><div class=\"debug-message\">"+text+"</div></td></tr>");

        if (userMessageNumber >= 30) {
          $('#userMessageTable').children().find('tr').last().remove();
        } else {
          ++userMessageNumber;
        }
      }

      function userMessageHandler() {
        $.ajax({
          url: '/usermessage',
          type: 'get',
          dataType: "json",
          success: function(message) {
            addUserMessageRow(message.date, message.text);
            userMessageHandler();
          }
        });
      }

      function getOldUserMessages() {
        $.ajax({
          url: '/get-old-user-message',
          type: 'post',
          dataType: "json",
          success: function(messages) {
            for (i = 0; i < messages.length; ++i) {
              addUserMessageRow(messages[i].date, messages[i].text);
            }
          }
        });
      }

      function getBluetoothMac() {
        $.ajax({
          url: '/get-bluetooth-mac',
          type: 'get',
          dataType: "json",
          success: function(message) {
            $('#btMacAddress').html("Bluetooth mac: "+message.mac);
          }
        });
      }

      function addDetourRow(data) {
        $('#detourTable').append("<tr class=\"finish-row\" id=\""+i+"\"><td>"+i+
                                 "</td><td>"+data.user_name+
                                 "</td><td>"+data.route_name+
                                 "</td><td>"+data.start_time+
                                 "</td><td>"+data.end_time+"</td></tr>");
      }

      function getDetourFomDb() {
        $.ajax({
          url: '/get-detour-from-db',
          type: 'post',
          dataType: "json",
          success: function(detour) {
            for (i = 0; i < detour.length; ++i) {
              addDetourRow(detour[i]);
            }
          }
        });
      }
    </script>
  
    <link rel="stylesheet" type="text/css" href="style.css">
    <link rel="shortcut icon" href="img/favicon.ico" />

  </head>

  <body bgcolor="#ffffff">
   	<H1 class="main-title">Report server</H1>
    <table width="100%" cellspacing="0" cellspacing="0" border="0">
      <tr>
        <td width="20%" valign="top" align="center">
          <img src="img/title.png" width="100%">
          <table width="100%" class="left-menu" cellspacing="0" cellspacing="0">
            <tr>
              <td>
                <table width="100%" cellspacing="0" cellspacing="0">
                  <tr>
                    <td align="left" colspan="2"><div name="bluetooth-address" class="bluetooth-mac" id="btMacAddress">Bluetooth mac: Чтение состояния...</div></td>
                  </tr>
                  <tr>
                    <td align="left" width="50%"><div class="bluetooth-mac">Состояние bluetooth:</div></td>
                    <td align="left" bgcolor="#cccccc"><div name="text1" class="btserver-status" id="btServerStatus">Чтение состояния...</div></td>
                  </tr>
                  <tr>
                    <td align="left"> <a href="without-javascript.html" onClick="bluetoothServerStart(); return false">Запустить</a></td>
                    <td align="left"><a href="without-javascript.html" onClick="bluetoothServerStop(); return false">Остановить</a></td>
                  </tr>
                </table>
              </td>
            </tr>
            <tr>
              <td>
                <div name="bluetooth-address" class="bluetooth-mac">Журнал событий:</div>
                <table width="100%" cellspacing="0" cellspacing="0" id="userMessageTable">
                </table>
              </td>
            </tr>
          </table>
        </td> 
    
        <td valign="top">
          <h3 align="left">Выполненные маршруты:</h3>
          <center>
            <table width="90%" style="border-width:1px; border-color:#ffffff; border-style:solid; background-color:#ffffff;" id="detourTable">
              <tr class="title-user-row">
                <td><a href="" class="sort-title">id</a></td>
                <td><a href="" class="sort-title">User</a></td>
                <td><a href="" class="sort-title">Route</a></td>
                <td><a href="" class="sort-title">Start</a></td>
                <td><a href="" class="sort-title">End</a></td>
              </tr>
            </table>
          </center>
          <p align="right"><a href="" class="element-on-page">[10]</a>, <a href="" class="element-on-page">[20]</a>, <a href="" class="element-on-page">[50]</a></p>

        </td>
        
        <td width="10%"></td>
      </tr>
    </table>
    <H5 class="main-title">copyright(c)</H5>
  </body>
</html>